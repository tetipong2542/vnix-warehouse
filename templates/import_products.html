{% extends "base.html" %}
{% block content %}

<div class="row g-3 align-items-end mb-3">
  <div class="col-auto">
    <div class="page-title d-flex align-items-center">
      <div class="page-title-icon me-3">
        üè∑Ô∏è
      </div>
      <div class="d-flex align-items-baseline flex-wrap">
        <div class="page-title-main me-3">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤: ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        <div class="text-muted" style="font-size: 1rem; border-left: 2px solid #ccc; padding-left: 12px;">
          ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Excel ‡∏´‡∏£‡∏∑‡∏≠ API
        </div>
      </div>
    </div>
  </div>
</div>
<hr class="mb-4">

<!-- Tabs Navigation -->
<ul class="nav nav-tabs mb-4" id="importTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-import" type="button" role="tab">
      <i class="bi bi-file-earmark-arrow-up"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api-import" type="button" role="tab">
      <i class="bi bi-cloud-arrow-down"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å API
    </button>
  </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="importTabContent">

  <!-- FILE IMPORT TAB -->
  <div class="tab-pane fade show active" id="file-import" role="tabpanel">
    <form method="post" enctype="multipart/form-data" class="row g-3">
      <div class="col-md-6">
        <label class="form-label">‡πÑ‡∏ü‡∏•‡πå Excel</label>
        <input type="file" name="file" class="form-control" required>
      </div>
      <div class="col-12">
        <button class="btn btn-primary">
          <i class="bi bi-upload"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤
        </button>
      </div>
    </form>
  </div>

  <!-- API IMPORT TAB -->
  <div class="tab-pane fade" id="api-import" role="tabpanel">
    <form id="apiImportForm" class="row g-3">

      <!-- Saved API Configs (Products) -->
      <div class="col-md-12">
        <div class="card bg-light">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-md-8">
                <label class="form-label">
                  <i class="bi bi-bookmark-star"></i> ‡πÇ‡∏´‡∏•‡∏î Products API Config ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
                </label>
                <select id="savedConfigSelect" class="form-select">
                  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Products Config ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ --</option>
                </select>
              </div>
              <div class="col-md-2">
                <button type="button" class="btn btn-info w-100" id="btnManageConfigs">
                  <i class="bi bi-gear"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                </button>
              </div>
              <div class="col-md-2">
                <button type="button" class="btn btn-success w-100" id="btnSaveConfig">
                  <i class="bi bi-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden fields for compatibility (not required) -->
      <input type="hidden" id="apiPlatform" value="">
      <input type="hidden" id="apiShopName" value="">

      <!-- API URL -->
      <div class="col-md-12">
        <label class="form-label">API URL <span class="text-danger">*</span></label>
        <input type="url" name="api_url" id="apiUrl" class="form-control"
               placeholder="https://api.example.com/products" required>
        <small class="text-muted">‡∏£‡∏∞‡∏ö‡∏∏ URL ‡∏Ç‡∏≠‡∏á API endpoint ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</small>
      </div>

      <!-- Data Path -->
      <div class="col-md-6">
        <label class="form-label">Data Path <span class="text-danger">*</span></label>
        <input type="text" name="data_path" id="dataPath" class="form-control"
               placeholder="data.products" required>
        <small class="text-muted">‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á array ‡πÉ‡∏ô JSON response (‡πÄ‡∏ä‡πà‡∏ô data.products, items)</small>
      </div>

      <!-- API Key / Token -->
      <div class="col-md-6">
        <label class="form-label">API Key / Token</label>
        <input type="text" name="api_key" id="apiKey" class="form-control"
               placeholder="Bearer YOUR_API_KEY">
        <small class="text-muted">‡∏Å‡∏£‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤ API ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ authentication</small>
      </div>

      <!-- Action Buttons -->
      <div class="col-12">
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-primary" id="btnFetchPreview">
            <i class="bi bi-cloud-download"></i> ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞ Preview
          </button>
          <button type="button" class="btn btn-outline-secondary" id="btnPreviewCache">
            <i class="bi bi-clock-history"></i> Preview Cache (6 ‡∏ä‡∏°.)
          </button>
          <a href="/import/products" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> ‡∏Å‡∏•‡∏±‡∏ö
          </a>
        </div>
      </div>

    </form>
  </div>

</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="previewModalLabel">
          <i class="bi bi-eye"></i> Preview ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• API
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Loading State -->
        <div id="previewLoading" class="text-center py-5" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API...</p>
        </div>

        <!-- Error State -->
        <div id="previewError" class="alert alert-danger" style="display: none;">
          <i class="bi bi-exclamation-triangle"></i> <span id="previewErrorMessage"></span>
        </div>

        <!-- Content -->
        <div id="previewContent" style="display: none;">
          <div class="alert alert-info hide-dev">
            <strong>Field Mapping:</strong>
            <div id="mappingInfo" class="mt-2"></div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped table-bordered">
              <thead class="table-light">
                <tr id="previewTableHeader"></tr>
              </thead>
              <tbody id="previewTableBody"></tbody>
            </table>
          </div>

          <div class="text-muted" id="previewSummary"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
        <button type="button" class="btn btn-primary" id="btnConfirmImport">
          <i class="bi bi-check-circle"></i> Confirm ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Mapping Modal -->
<div class="modal fade" id="editMappingModal" tabindex="-1" aria-labelledby="editMappingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="editMappingModalLabel">
          <i class="bi bi-pencil"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Field Mapping
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏à‡∏≤‡∏Å API ‡∏Å‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö WMS</p>
        <form id="mappingForm">
          <div class="row g-3" id="mappingFormFields"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button type="button" class="btn btn-primary" id="btnSaveMapping">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Mapping</button>
      </div>
    </div>
  </div>
</div>

<!-- Config Management Modal -->
<div class="modal fade" id="manageConfigsModal" tabindex="-1" aria-labelledby="manageConfigsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="manageConfigsModalLabel">
          <i class="bi bi-gear"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ API Configurations
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Loading State -->
        <div id="configsLoading" class="text-center py-5" style="display: none;">
          <div class="spinner-border text-info" role="status">
            <span class="visually-hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
          </div>
          <p class="mt-2 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î Configs...</p>
        </div>

        <!-- Error State -->
        <div id="configsError" class="alert alert-danger" style="display: none;">
          <i class="bi bi-exclamation-triangle"></i> <span id="configsErrorMessage"></span>
        </div>

        <!-- Configs Table -->
        <div id="configsTableContainer" style="display: none;">
          <div class="table-responsive">
            <table class="table table-hover table-bordered">
              <thead class="table-light">
                <tr>
                  <th style="width: 25%;">‡∏ä‡∏∑‡πà‡∏≠ Config</th>
                  <th style="width: 12%;">Platform</th>
                  <th style="width: 30%;">API URL</th>
                  <th style="width: 15%;">Data Path</th>
                  <th style="width: 18%;" class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="configsTableBody">
                <!-- Rows will be populated by JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- Summary -->
          <div class="text-end text-muted mt-2">
            <small>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong id="configsCount">0</strong> configs</small>
          </div>
        </div>

        <!-- Empty State -->
        <div id="configsEmpty" class="text-center py-5" style="display: none;">
          <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
          <p class="text-muted mt-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Config ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>
          <p class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• API ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> ‡∏õ‡∏¥‡∏î
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Config Detail Modal -->
<div class="modal fade" id="viewConfigModal" tabindex="-1" aria-labelledby="viewConfigModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="viewConfigModalLabel">
          <i class="bi bi-info-circle"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Config
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3" id="viewConfigContent">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfigModal" tabindex="-1" aria-labelledby="deleteConfigModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfigModalLabel">
          <i class="bi bi-exclamation-triangle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö Config
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö Config ‡∏ô‡∏µ‡πâ?</p>
        <div class="card bg-light">
          <div class="card-body">
            <div class="row g-2">
              <div class="col-12">
                <strong>‡∏ä‡∏∑‡πà‡∏≠ Config:</strong>
                <span id="deleteConfigName" class="text-primary"></span>
              </div>
              <div class="col-6">
                <strong>Platform:</strong>
                <span id="deleteConfigPlatform"></span>
              </div>
              <div class="col-6">
                <strong>Shop ID:</strong>
                <span id="deleteConfigShopId"></span>
              </div>
              <div class="col-12">
                <strong>API URL:</strong>
                <div class="text-truncate text-muted" id="deleteConfigUrl"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="alert alert-warning mt-3 mb-0">
          <i class="bi bi-exclamation-triangle"></i>
          <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
        <button type="button" class="btn btn-danger" id="btnConfirmDelete">
          <i class="bi bi-trash"></i> ‡∏•‡∏ö Config
        </button>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='api_import_common.js') }}"></script>
<script>
  // Initialize API Import for Products after DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOMContentLoaded - Initializing Products API Import...');

    window.apiImportCommon.init({
      moduleType: 'products',
      apiEndpoint: '/import/products/api',
      displayFields: ['sku', 'product_name'], // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      fieldLabels: {
        'sku': '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        'product_name': '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        'item_name': '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        'name': '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        'product_code': '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'
      },
      wmsFields: [
        { key: 'sku', label: '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' },
        { key: 'product_code', label: '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏£‡∏≠‡∏á)' },
        { key: 'product_name', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' },
        { key: 'item_name', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏£‡∏≠‡∏á)' },
        { key: 'name', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏£‡∏≠‡∏á 2)' }
      ],
      requirePlatform: false,
      requireShopName: false,
      redirectUrl: '/import/products'
    });
  });
</script>

{% endblock %}
