<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (No Stock)</title>
  <style>
    html, body { font-family: Tahoma, "Noto Sans Thai", sans-serif; font-size: 12px; }
    @page { size: A4 landscape; margin: 8mm; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin: 10px 0 10px; }
    .toolbar .meta { color: #333; padding: 6px 10px; background: #f3f7ff; border: 1px solid #d9e3ff; border-radius: 4px; }
    .btn { padding: 6px 10px; border: 1px solid #333; background: #fff; cursor: pointer; border-radius: 4px; text-decoration: none; display: inline-block; }
    .btn.primary { background: #1a73e8; color: #fff; border-color: #1a73e8; }
    .btn.success { background: #1b9e3d; color: #fff; border-color: #1b9e3d; }
    .btn.ghost { background: #fff; color: #333; border-color: #bbb; }
    .filters { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
    .filters input[type="text"], .filters select, .filters input[type="number"] { height: 30px; padding: 0 8px; border: 1px solid #bbb; border-radius: 4px; }
    .filters label { color: #555; font-size: 12px; }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      page-break-inside: auto; 
      margin-top: 8px; 
      table-layout: fixed;
    }
    thead th { position: sticky; top: 0; background: #f7f7f7; z-index: 5; }
    th, td { 
      border: 1px solid #d0d0d0; 
      padding: 6px 8px; 
      vertical-align: top; 
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      line-height: 1.15;
    }
    th { text-align: left; }
    th a { color: #333; text-decoration: none; }
    th a:hover { text-decoration: underline; }
    td:nth-child(6) { width: 240px; }
    td:nth-child(13) { width: 220px; }
    tbody tr:nth-child(even) td { background: #f9f9f9; }
    tr.group-start td { border-top: 3px solid #000; }
    tr.group-end td   { border-bottom: 3px solid #000; }
    tr.group-row { page-break-inside: avoid; }
    td.sla-overdue { color: #b00020; font-weight: 600; }
    .muted { color: #777; }
    .right { text-align: right; }
    .center { text-align: center; }
    .capsule { padding: 2px 6px; border-radius: 10px; border: 1px solid #ddd; background: #f8f8f8; display: inline-block; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-menu { display: none; position: absolute; right: 0; background: #fff; border: 1px solid #ccc; min-width: 200px; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .dropdown:hover .dropdown-menu { display: block; }
    .dropdown-menu a { display: block; padding: 6px 10px; text-decoration: none; color: #333; }
    .dropdown-menu a:hover { background: #f3f3f3; }
    .signbox { margin-top: 14px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .sign { border: 1px dashed #bbb; border-radius: 6px; padding: 10px; min-height: 70px; }
    .sign b { display:block; margin-bottom: 6px; }
    @media print {
      .toolbar { display: none; }
      thead { display: table-header-group; }
      tr { page-break-inside: avoid; page-break-after: auto; }
      html, body { font-size: 11px; }
      th, td { 
        white-space: normal !important;
        overflow-wrap: anywhere;
        word-break: break-word;
      }
      body { margin: 0; }
    }
  </style>
</head>
<body>

  {% set csv_oids = (order_ids|join(",")) if order_ids is defined else "" %}

  <div class="toolbar">
    <a class="btn ghost" href="{{ url_for('dashboard') }}">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>

    <button class="btn" onclick="window.print()">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>

    <form method="post" action="{{ url_for('report_nostock_print') }}" style="display:inline;"
          onsubmit="return confirmPrintOnce(this)">
      <input type="hidden" name="order_ids" value="{{ csv_oids }}">
      <button class="btn primary" type="submit">‡∏û‡∏¥‡∏°‡∏û‡πå (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)</button>
    </form>

    <a class="btn ghost" href="{{ url_for('report_nostock_export',
          platform=platform_sel, shop_id=shop_sel, logistic=logistic_sel,
          q=q, sort=sort_col, dir=sort_dir, round=round_sel) }}">Excel</a>

    <div class="meta">
      <b>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (No Stock)</b>
      <span class="capsule">SKU ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <b>{{ summary.sku_count if summary is defined else 0 }}</b></span>
      <span class="capsule">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: <b>{{ summary.orders_count if summary is defined else 0 }}</b></span>
      {% if is_history_view and printed_at %}
        <span class="capsule">‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå: <b>{{ printed_at.strftime('%d/%m/%Y %H:%M:%S') }}</b></span>
      {% endif %}
    </div>

    <div class="dropdown" style="margin-left:auto;">
      <button class="btn">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‚ñº</button>
      <div class="dropdown-menu">
        <a href="{{ url_for('report_nostock_printed') }}">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
        {% if available_dates is defined and available_dates %}
          <div class="muted" style="padding:4px 10px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</div>
          {% for d in available_dates %}
            <a href="{{ url_for('report_nostock_printed', print_date=d) }}">{{ d }}</a>
          {% endfor %}
        {% endif %}
      </div>
    </div>
  </div>

  <form class="toolbar filters" method="get" action="{{ url_for('report_nostock') if not is_history_view else url_for('report_nostock_printed') }}">
    <label>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</label>
    <select name="platform">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      <option value="shopee"  {% if platform_sel=='shopee' %}selected{% endif %}>Shopee</option>
      <option value="lazada"  {% if platform_sel=='lazada' %}selected{% endif %}>Lazada</option>
      <option value="tiktok"  {% if platform_sel=='tiktok' %}selected{% endif %}>TikTok</option>
    </select>

    <label>‡∏£‡πâ‡∏≤‡∏ô</label>
    <select name="shop_id">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      {% for s in shops or [] %}
        <option value="{{ s.id }}" {% if shop_sel and s.id==shop_sel|int %}selected{% endif %}>
          {{ s.platform }} ‚Ä¢ {{ s.name }}
        </option>
      {% endfor %}
    </select>

    <label>‡∏Ç‡∏ô‡∏™‡πà‡∏á</label>
    <select name="logistic">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      {% for lg in logistics or [] %}
        <option value="{{ lg }}" {% if logistic_sel==lg %}selected{% endif %}>{{ lg }}</option>
      {% endfor %}
    </select>

    {% if is_history_view %}
      <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå</label>
      <select name="print_date">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        {% for d in available_dates or [] %}
          <option value="{{ d }}" {% if print_date_sel==d %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
      </select>
    {% else %}
      <input type="text" name="q" value="{{ q or '' }}" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Order, SKU, Brand, ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏£‡πâ‡∏≤‡∏ô, ‡∏Ç‡∏ô‡∏™‡πà‡∏á)">
    {% endif %}

    <label>‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà</label>
    <select name="round">
      <option value="all" {% if round_sel in (None, '', 'all') %}selected{% endif %}>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      {% for r in range(1,11) %}
        <option value="{{ r }}" {% if round_sel|string==r|string %}selected{% endif %}>{{ r }}</option>
      {% endfor %}
    </select>

    <button class="btn" type="submit">‡∏Å‡∏£‡∏≠‡∏á</button>
    {% set clear_url = url_for('report_nostock') if not is_history_view else url_for('report_nostock_printed') %}
    {% if q or platform_sel or shop_sel or logistic_sel or (is_history_view and print_date_sel) or (round_sel not in (None, '', 'all')) %}
      <a class="btn ghost" href="{{ clear_url }}">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</a>
    {% endif %}
  </form>

  {% if not is_history_view and order_ids and order_ids|length>0 %}
  <div class="toolbar" style="gap:6px;">
    <label>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô(‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà):</label>
    <input id="round-input" type="number" min="1" step="1" style="width:80px;height:30px;padding:0 6px;border:1px solid #bbb;border-radius:4px;">
    <button class="btn success" type="button" onclick="updateRound()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ</button>
    <span class="muted">‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå <b>nostock_round</b> (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á/Picking)</span>
  </div>
  {% endif %}

  <table>
    <thead>
      <tr>
        {% macro th(label, col) -%}
          {% set target_ep = 'report_nostock_printed' if is_history_view else 'report_nostock' %}
          {% set toggle = 'asc' if (sort_col!=col or sort_dir=='desc') else 'desc' %}
          <th>
            <a href="{{ url_for(target_ep,
                                platform=platform_sel, shop_id=shop_sel, logistic=logistic_sel,
                                q=q, print_date=print_date_sel, sort=col, dir=toggle, round=round_sel) }}"
               title="‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° {{ label }}">{{ label }}
               {% if sort_col==col %} <span class="muted">{{ '‚Üë' if sort_dir=='asc' else '‚Üì' }}</span>{% endif %}
            </a>
          </th>
        {%- endmacro %}

        {{ th('‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°', 'platform') }}
        {{ th('‡∏£‡πâ‡∏≤‡∏ô', 'store') }}
        {{ th('‡πÄ‡∏•‡∏Ç Order', 'order_no') }}
        {{ th('SKU', 'sku') }}
        {{ th('Brand', 'brand') }}
        {{ th('‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 'product_name') }}
        {{ th('Stock', 'stock') }}
        {{ th('Qty', 'qty') }}
        {{ th('AllQty', 'allqty') }}
        {{ th('‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á', 'order_time') }}
        {{ th('‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á', 'due_date') }}
        {{ th('SLA (‡∏ä‡∏°.)', 'sla') }}
        {{ th('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á', 'shipping_type') }}
        {{ th('‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô(‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà)', 'assign_round') }}
        {{ th('‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)', 'printed_count') }}
        {{ th('‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ/‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå', 'printed_at') }}
        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
      </tr>
    </thead>
    <tbody>
      {% set prev_order = None %}
      {% for r in rows %}
        {% set is_start = (prev_order != r.order_no) %}
        {% if not loop.last %}{% set next_order = rows[loop.index0 + 1].order_no %}{% else %}{% set next_order = None %}{% endif %}
        {% set is_end = (next_order != r.order_no) %}
        {% set ok = (r.stock is not none and r.allqty is not none and (r.stock|int) >= (r.allqty|int)) %}
        <tr class="group-row {% if is_start %}group-start{% endif %} {% if is_end %}group-end{% endif %} {% if ok %}ok{% else %}warn{% endif %}">
          <td>{{ r.platform }}</td>
          <td>{{ r.store }}</td>
          <td><b>{{ r.order_no }}</b></td>
          <td>{{ r.sku }}</td>
          <td>{{ r.brand }}</td>
          <td class="wrap" style="max-width: 320px;">{{ r.product_name }}</td>
          <td class="right">{{ r.stock }}</td>
          <td class="right">{{ r.qty }}</td>
          <td class="right">{{ r.allqty }}</td>
          <td>{{ r.order_time }}</td>
          <td>{{ r.due_date }}</td>
          <td class="right {% if r.sla and ('‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î' in (r.sla|string)) %}sla-overdue{% endif %}">{{ r.sla }}</td>
          <td>{{ r.shipping_type }}</td>
          <td class="center">{{ r.assign_round if r.assign_round is not none else '' }}</td>
          <td class="center">{{ r.printed_count or 0 }}</td>
          <td>{{ r.printed_at.strftime('%d/%m/%Y %H:%M:%S') if r.printed_at else '' }}</td>
          <td class="text-danger small">
            {% if r.note %}‚ö†Ô∏è {{ r.note }}{% endif %}
          </td>
        </tr>
        {% set prev_order = r.order_no %}
      {% endfor %}
      {% if not rows or rows|length == 0 %}
        <tr><td colspan="17" class="center muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</td></tr>
      {% endif %}
    </tbody>
  </table>

  <div class="signbox">
    <div class="sign">
      <b>‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</b>
      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤: _________________________________
    </div>
    <div class="sign">
      <b>‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</b>
      ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤: _________________________________
    </div>
  </div>

  {% if is_history_view %}
    <div class="toolbar" style="margin-top:10px;">
      <div class="meta">üìã ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
    </div>
  {% endif %}

  <script>
    function confirmPrintOnce(form){
      if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥?')) return false;
      const btn = form.querySelector('button[type=submit]');
      if(btn){ btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶'; }
      return true;
    }

    async function updateRound() {
      const v = document.getElementById('round-input').value;
      if (!v) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà'); return; }
      const oids = "{{ csv_oids }}".split(',').filter(Boolean);
      if (oids.length === 0) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ'); return; }
      if (!confirm('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô ' + v + ' ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö ' + oids.length + ' ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå?')) return;
      try {
        const res = await fetch('{{ url_for("update_nostock_round") }}', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ order_ids: oids, round: v })
        });
        const j = await res.json();
        if (j.success) {
          alert(j.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          location.reload();
        } else {
          alert(j.message || '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }
      } catch (e) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e); }
    }
  </script>
</body>
</html>
